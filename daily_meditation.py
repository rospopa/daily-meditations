#!/usr/bin/env python3
import random
import os
import json
import time
import re
from pathlib import Path
import sys
from twilio.rest import Client

# Configuration file path
CONFIG_FILE = Path(__file__).parent / "config.json"

# Daily meditations - a collection of fitness, yoga, and philosophical quotes
MEDITATIONS = [
    # Quotes
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Більше всього я боюся самозрадництва. — Василь Стус",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Поезія — це свідчення нашого часу. — Василь Стус",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Істина завжди поза межами комфорту. — Василь Стус",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Не обирай легких шляхів — обирай істину. — Василь Стус",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Людина, яка не бореться, вже програла. — Василь Стус",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Сила слова сильніша за силу кайданів. — Василь Стус",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Вічність — це короткі миті щастя. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Тільки той, хто вміє мовчати, чує голос серця. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Свобода починається там, де закінчується страх. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Ніколи не дозволяй світові вирішувати твою ціну. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Поезія — це святий дзвін душі. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Життя — це боротьба за власне «я». — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Людина творить своє щастя сама. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Справжня любов — це дар, а не обов’язок. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Мистецтво живе там, де людина не боїться бути собою. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Слова можуть зцілити, але й поранити. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Кожен день — шанс змінити світ навколо. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Мова — це не просто слова, це душа народу. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Не бійся бути іншою, бо саме в цьому сила. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Справжня поезія не старіє, вона живе в серці. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Час лікує не все, але він відкриває правду. — Ліна Костенко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Ти не зможеш любити, поки не навчишся бути вільним. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Справжня людина не шукає легких шляхів. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Не той герой, хто сильний тілом, а хто сильний духом. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Любов — це не слова, а вчинки. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Людина — творець свого щастя і нещастя. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Ми повинні жити так, щоб нас пам’ятали. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Свобода не дарується, її здобувають. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Поезія — це голос серця, який не можна замовчати. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Справжнє братство народжується у біді. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Життя коротке, тож цінуй кожну мить. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Гідність важливіша за багатство. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Ніколи не мовчи, коли твоє слово може врятувати. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Людина без мрії — як дерево без кореня. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Тільки той, хто страждав, може по-справжньому любити. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Сила народу — у його правді. — Василь Симоненко",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Свобода — це коли ти не боїшся бути собою. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Ми живемо в світі, де правда постійно на вагу золота. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Поезія врятує світ, але спершу врятує тебе. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Любов завжди починається з поваги до іншого. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Сміливість — це робити крок вперед, навіть коли страшно. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Людська гідність не продається. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Найбільша сила — це залишатися людяним. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Життя — це нескінченний вибір між страхом і надією. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Мрія без дії — це просто фантазія. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Місто оживає у словах і музиці його людей. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Люди забувають історію, і вона повторюється. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Ми повинні пам’ятати, хто ми є. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Тільки ті, хто любить, можуть творити. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Кожен день — це маленька революція у власному житті. — Сергій Жадан",
    "«Оксана Роспопа, настав час тренувати тіло і розум.» Мова — це не просто засіб спілкування, це голос душі. — Сергій Жадан",
]

def load_config():
    """Load configuration from config file."""
    try:
        with open(CONFIG_FILE, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        # Default configuration
        return {
            "twilio": {
                "account_sid": "ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                "auth_token": "your_twilio_auth_token",
                "phone_number": "+1234567890"
            },
            "recipients": ["+1234567890"],  # List of phone numbers with country code
            "history_size": 7,
            "history": []
        }

def save_config(config):
    """Save configuration to config file."""
    with open(CONFIG_FILE, 'w') as f:
        json.dump(config, f, indent=4)

def select_random_meditation(config):
    """Select a random meditation that hasn't been sent recently."""
    history = set(config.get("history", []))
    available_meditations = [m for m in range(len(MEDITATIONS)) if m not in history]
    
    if not available_meditations:
        # If we've used all meditations, reset history
        available_meditations = list(range(len(MEDITATIONS)))
        history = set()
    
    selected = random.choice(available_meditations)
    
    # Update history
    history.add(selected)
    if len(history) > config.get("history_size", 7):
        history.remove(next(iter(history)))  # Remove oldest entry
    
    config["history"] = list(history)
    save_config(config)
    
    return MEDITATIONS[selected], selected + 1

def send_sms(config, meditation, meditation_number):
    """Send an SMS with the daily meditation to all recipients using Twilio API."""
    twilio_config = config["twilio"]
    
    account_sid = twilio_config["account_sid"]
    auth_token = twilio_config["auth_token"]
    twilio_phone_number = twilio_config["phone_number"]
    
    client = Client(account_sid, auth_token)
    
    # Format the message
    message_body = f"Daily Meditation #{meditation_number}:\n\n{meditation}"
    print(f"Prepared message: {message_body[:50]}...")
    
    for recipient in config["recipients"]:
        try:
            print(f"\n=== Processing recipient: {recipient} ===")
            message = client.messages.create(
                to=recipient,
                from_=twilio_phone_number,
                body=message_body
            )
            print(f"✅ Successfully sent SMS to {recipient}. SID: {message.sid}")
        except Exception as e:
            print(f"❌ Failed to send SMS to {recipient}: {e}")
            continue

def main():
    """Main function to send daily meditation via SMS."""
    try:
        # Load configuration
        config = load_config()
        
        # Select a random meditation
        meditation, meditation_number = select_random_meditation(config)
        
        # Send SMS
        send_sms(config, meditation, meditation_number)
        print(f"Successfully sent meditation #{meditation_number} via SMS")
        return 0
        
    except Exception as e:
        print(f"Error: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(main())
